<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PariBasha</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .assistant-container {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .btn-glow:hover {
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
        }
        #responseArea, #userInput {
            scrollbar-width: thin;
            scrollbar-color: #9CA3AF #F3F4F6;
        }
        #responseArea::-webkit-scrollbar, #userInput::-webkit-scrollbar {
            width: 8px;
        }
        #responseArea::-webkit-scrollbar-track, #userInput::-webkit-scrollbar-track {
            background: #F3F4F6;
        }
        #responseArea::-webkit-scrollbar-thumb, #userInput::-webkit-scrollbar-thumb {
            background-color: #9CA3AF;
            border-radius: 10px;
            border: 3px solid #F3F4F6;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            position: absolute;
            top: 50%;
            left: 50%;
            margin-top: -20px;
            margin-left: -20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="assistant-container bg-white rounded-2xl p-6 md:p-8 w-full max-w-2xl mx-4">
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">PariBasha</h1>
            <p class="text-gray-500 mt-2">Your guide to Hindu temples across India. Ask in English or Hindi.</p>
        </div>

        <div class="flex flex-col sm:flex-row justify-center items-center my-4 gap-4">
            <div class="flex items-center">
                <label for="inputLangSelect" class="mr-2 font-medium text-gray-700">Input Language:</label>
                <select id="inputLangSelect" class="rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                    <option value="en-IN">English</option>
                    <option value="hi-IN">हिन्दी (Hindi)</option>
                </select>
            </div>
            <div class="flex items-center">
                <label for="responseLangSelect" class="mr-2 font-medium text-gray-700">Response Language:</label>
                <select id="responseLangSelect" class="rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                    <option value="en-IN">English</option>
                    <option value="hi-IN">हिन्दी (Hindi)</option>
                </select>
            </div>
        </div>

        <div class="space-y-4">
            <textarea id="userInput" class="w-full h-24 p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Ask your question here, or use the microphone..."></textarea>
            
            <div class="flex flex-col sm:flex-row gap-3">
                <button id="listenBtn" class="w-full bg-blue-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-600 transition-all duration-300 ease-in-out btn-glow flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
                    <span id="listenBtnText">Start Listening</span>
                </button>
                <button id="stopBtn" class="w-full bg-red-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-red-600 transition-all duration-300 ease-in-out btn-glow flex items-center justify-center gap-2" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><line x1="12" x2="12" y1="8" y2="16"/></svg>
                    Stop Speaking
                </button>
                 <button id="sendBtn" class="w-full bg-green-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-green-600 transition-all duration-300 ease-in-out btn-glow flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" x2="11" y1="2" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                    Send Text
                </button>
            </div>
        </div>

        <div id="status" class="text-center text-gray-600 my-4 h-6"></div>

        <div class="relative mt-4">
             <div id="loader" class="loader hidden"></div>
             <div id="responseArea" class="w-full h-48 p-4 bg-gray-50 border border-gray-200 rounded-lg overflow-y-auto">
                <p class="text-gray-400">Assistant's response will appear here...</p>
            </div>
        </div>
        
        <div id="errorArea" class="text-red-500 text-center mt-4 font-medium"></div>

    </div>

    <script>
        const listenBtn = document.getElementById('listenBtn');
        const listenBtnText = document.getElementById('listenBtnText');
        const stopBtn = document.getElementById('stopBtn');
        const sendBtn = document.getElementById('sendBtn');
        const userInput = document.getElementById('userInput');
        const status = document.getElementById('status');
        const responseArea = document.getElementById('responseArea');
        const errorArea = document.getElementById('errorArea');
        const loader = document.getElementById('loader');
        const inputLangSelect = document.getElementById('inputLangSelect');
        const responseLangSelect = document.getElementById('responseLangSelect');

        const GEMINI_API_KEY = 'AIzaSyCzTnLlWi3gq7vgH2HFUtqPLMBQYFaTfr0';
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
        
        let recognition;
        let speech = new SpeechSynthesisUtterance();
        let isListening = false;
        
        // Initialize the voice based on the default response dropdown value
        setSpeechSynthesisVoice(responseLangSelect.value);

        // Check for browser support for Speech Recognition
        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;

            recognition.onstart = () => {
                isListening = true;
                listenBtnText.textContent = 'Listening...';
                listenBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                listenBtn.classList.remove('bg-blue-500', 'hover:bg-blue-500');
                status.textContent = 'Listening... please speak.';
                errorArea.textContent = '';
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                userInput.value = transcript;
                status.textContent = 'Processing your query...';
                getAIResponse(transcript);
            };

            recognition.onerror = (event) => {
                let errorMessage = 'An error occurred with speech recognition.';
                if (event.error === 'no-speech') {
                    errorMessage = 'No speech was detected. Please try again.';
                } else if (event.error === 'audio-capture') {
                    errorMessage = 'Microphone problem. Please ensure it is enabled and working.';
                } else if (event.error === 'not-allowed') {
                    errorMessage = 'Permission to use microphone was denied. Please allow microphone access.';
                }
                errorArea.textContent = errorMessage;
                status.textContent = '';
                resetListenButton();
            };

            recognition.onend = () => {
                isListening = false;
                resetListenButton();
                 if (status.textContent === 'Listening... please speak.') {
                    status.textContent = '';
                }
            };

        } else {
            const unsupportedMessage = "Speech recognition is not supported by your browser. Please use Google Chrome.";
            listenBtn.disabled = true;
            status.textContent = unsupportedMessage;
            errorArea.textContent = unsupportedMessage;
        }

        responseLangSelect.addEventListener('change', () => {
            setSpeechSynthesisVoice(responseLangSelect.value);
        });

        listenBtn.addEventListener('click', () => {
            if (!isListening) {
                try {
                    // Set recognition language from input dropdown
                    recognition.lang = inputLangSelect.value;
                    // Set synthesis (speaking) voice from response dropdown
                    setSpeechSynthesisVoice(responseLangSelect.value);
                    recognition.start();
                } catch(e) {
                     errorArea.textContent = "Could not start listening. Please check microphone permissions.";
                     resetListenButton();
                }
            } else {
                recognition.stop();
            }
        });

        stopBtn.addEventListener('click', () => {
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
                stopBtn.disabled = true;
            }
        });

        sendBtn.addEventListener('click', () => {
            const text = userInput.value.trim();
            if(text){
                status.textContent = 'Processing your query...';
                // Ensure synthesis voice matches response dropdown for typed text
                setSpeechSynthesisVoice(responseLangSelect.value);
                getAIResponse(text);
            } else {
                errorArea.textContent = "Please enter a question before sending.";
            }
        });


        function resetListenButton() {
            listenBtnText.textContent = 'Start Listening';
            listenBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
            listenBtn.classList.add('bg-blue-500', 'hover:bg-blue-500');
        }

        async function getAIResponse(prompt) {
            loader.classList.remove('hidden');
            if (GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY') {
                errorArea.textContent = 'API Key is not set. Please add your Google Gemini API key in the script.';
                status.textContent = '';
                loader.classList.add('hidden');
                return;
            }

            try {
                const responseLanguage = responseLangSelect.options[responseLangSelect.selectedIndex].text;
                const systemMessage = `You are a helpful voice assistant for pilgrims visiting Hindu temples in India. 
                Your name is 'PariBasha'.
                Provide information about temple history, location, timings, nearby facilities, travel, and significance.
                Keep responses concise and clear for a voice assistant.
                IMPORTANT: You MUST answer ONLY in the following language: ${responseLanguage}, regardless of the user's input language.
                Provide real-time information where possible, but state if you cannot access live data and give general information instead (e.g., "Temple timings are generally from... but can vary.").`;
                
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    systemInstruction: {
                        parts: [{ text: systemMessage }]
                    },
                };

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${response.status} - ${errorData.error.message}`);
                }

                const data = await response.json();
                
                const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!aiText) {
                    throw new Error("No content received from API. The response may have been blocked due to safety settings.");
                }

                responseArea.innerHTML = `<p>${aiText.replace(/\n/g, '<br>')}</p>`;
                speak(aiText);

            } catch (error) {
                console.error('Error fetching from Google Gemini API:', error);
                errorArea.textContent = `Failed to get response from the assistant. ${error.message}`;
                responseArea.innerHTML = `<p class="text-gray-400">Could not fetch a response. Please check your connection and API key.</p>`;
            } finally {
                loader.classList.add('hidden');
                status.textContent = '';
            }
        }

        function setSpeechSynthesisVoice(lang) {
            // This function logs the available voices for debugging purposes.
            // You can open the browser console (F12) to see this list.
            console.log("Available voices:", speechSynthesis.getVoices().map(v => `${v.name} (${v.lang})`));
            
            const setVoice = () => {
                const voices = speechSynthesis.getVoices();
                if (voices.length === 0) {
                    console.warn("Speech synthesis voices not loaded yet.");
                    return;
                }

                let selectedVoice = null;

                // Find the best matching voice
                if (lang.startsWith('hi')) {
                    // Prioritize known good Hindi voices by name or language code
                    selectedVoice = voices.find(voice => voice.name === 'Google हिन्दी' || voice.lang === 'hi-IN');
                    // If not found, take the first available Hindi voice
                    if (!selectedVoice) {
                        selectedVoice = voices.find(voice => voice.lang.startsWith('hi'));
                    }
                } else { // This block handles English ('en-IN')
                     // 1. Strongly prefer an Indian English voice.
                     selectedVoice = voices.find(voice => voice.lang === 'en-IN');
                     
                     // 2. If not found, fall back to any available English voice.
                     if (!selectedVoice) {
                        console.warn("Indian English (en-IN) voice not found. Falling back to default English voice.");
                        selectedVoice = voices.find(voice => voice.lang.startsWith('en'));
                     }
                }

                if (selectedVoice) {
                    speech.voice = selectedVoice;
                    speech.lang = selectedVoice.lang;
                    console.log(`Using voice: ${selectedVoice.name} for language: ${selectedVoice.lang}`);
                } else {
                    // Fallback if no specific voice is found
                    speech.lang = lang;
                    console.warn(`No specific voice found for lang '${lang}'. Using browser default.`);
                }
            };

            // Voices can load asynchronously. We need to handle both cases.
            if (speechSynthesis.getVoices().length) {
                setVoice();
            } else {
                 speechSynthesis.onvoiceschanged = setVoice;
            }
        }

        function speak(text) {
            // Stop any currently speaking utterance before starting a new one.
            speechSynthesis.cancel();

            // Only remove characters that might be read aloud, but keep punctuation for pauses.
            const cleanedText = text.replace(/[*"“]/g, '');
            speech.text = cleanedText;
            
            speech.onstart = () => {
                stopBtn.disabled = false;
            };

            speech.onend = () => {
                stopBtn.disabled = true;
            };
            
            speechSynthesis.speak(speech);
        }

    </script>
</body>
</html>